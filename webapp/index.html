<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRCA SOE Viva Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }
        .screen { display: none; }
        .screen.active { display: flex; }

        /* ‚îÄ‚îÄ Entry Screen ‚îÄ‚îÄ */
        .entry-screen { flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }
        .logo { font-size: 2.5rem; margin-bottom: 0.5rem; }
        h1 { font-size: 2rem; color: #fff; margin-bottom: 0.25rem; }
        .subtitle { color: #888; margin-bottom: 2.5rem; font-size: 1.1rem; }
        .badge { display: inline-block; background: #1e3a5f; color: #5ba3e6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .name-form { display: flex; flex-direction: column; align-items: center; gap: 1rem; width: 100%; max-width: 400px; }
        .name-form label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 0.05em; }
        .name-form input { width: 100%; padding: 0.75rem 1rem; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 1.1rem; text-align: center; outline: none; }
        .name-form input:focus { border-color: #5ba3e6; }
        .name-form input::placeholder { color: #555; }
        .btn { padding: 0.75rem 2.5rem; background: #5ba3e6; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn:hover { background: #4a8fd4; }
        .btn:disabled { background: #333; cursor: not-allowed; color: #666; }
        .btn-outline { background: transparent; border: 1px solid #5ba3e6; color: #5ba3e6; }
        .btn-outline:hover { background: #5ba3e610; }
        .btn-danger { background: #3a1a1a; color: #e65b5b; border: 1px solid #5b2a2a; padding: 0.5rem 1.25rem; font-size: 0.85rem; }
        .btn-danger:hover { background: #4a2020; }
        .instructions-brief { max-width: 400px; margin-top: 2rem; padding: 1.25rem; background: #1a1a1a; border: 1px solid #222; border-radius: 10px; font-size: 0.85rem; color: #888; line-height: 1.6; }
        .instructions-brief strong { color: #bbb; }
        .error-notice { color: #e65b5b; font-size: 0.8rem; margin-top: 0.5rem; display: none; }
        .mic-notice { color: #e6a35b; font-size: 0.8rem; margin-top: 0.5rem; display: none; }

        /* ‚îÄ‚îÄ SOE Part Selector ‚îÄ‚îÄ */
        .soe-selector { display: flex; gap: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .soe-option label { display: flex; align-items: center; gap: 0.4rem; cursor: pointer; color: #bbb; font-size: 0.95rem; }
        .soe-option label.disabled { opacity: 0.4; cursor: not-allowed; }
        .soe-option input[type="radio"] { accent-color: #5ba3e6; }
        .pool-notice { color: #e88; font-size: 0.8rem; margin-left: 1.8rem; margin-top: 0.15rem; }

        /* ‚îÄ‚îÄ Exam Screen ‚îÄ‚îÄ */
        .exam-screen { flex-direction: column; height: 100vh; }
        .exam-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: #111; border-bottom: 1px solid #222; }
        .candidate-name { color: #5ba3e6; font-weight: 600; }
        .exam-title { color: #888; font-size: 0.9rem; }
        .timer { font-family: 'SF Mono', 'Fira Code', monospace; color: #5ba3e6; font-size: 1.1rem; background: #1a1a1a; padding: 0.3rem 0.75rem; border-radius: 6px; border: 1px solid #333; }
        .timer.warning { color: #e6a35b; border-color: #e6a35b; }
        .timer.critical { color: #e65b5b; border-color: #e65b5b; }
        .examiner-indicator { display: flex; align-items: center; gap: 0.5rem; }
        .examiner-badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 4px; background: #1a2a3a; color: #5ba3e6; font-weight: 600; }
        .transcript-container { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .transcript-msg { max-width: 80%; padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .transcript-msg.examiner { background: #1a2a3a; color: #d0e0f0; align-self: flex-start; border-bottom-left-radius: 4px; }
        .transcript-msg.examiner::before { content: attr(data-examiner); display: block; font-size: 0.7rem; color: #5ba3e6; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .transcript-msg.candidate { background: #2a2a2a; color: #ccc; align-self: flex-end; border-bottom-right-radius: 4px; }
        .transcript-msg.candidate::before { content: 'You'; display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; text-align: right; }
        .transcript-msg.system { align-self: center; background: none; color: #555; font-size: 0.8rem; font-style: italic; }
        .status-bar { padding: 0.75rem 1.5rem; background: #111; border-top: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #888; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.listening { background: #5be67a; animation: pulse 1.5s infinite; }
        .status-dot.speaking { background: #5ba3e6; animation: pulse 1s infinite; }
        .status-dot.connected { background: #5be67a; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* ‚îÄ‚îÄ View Toggle ‚îÄ‚îÄ */
        .view-toggle { display: flex; background: #111; border-bottom: 1px solid #222; padding: 0 1.5rem; }
        .view-toggle button { background: none; border: none; color: #555; font-size: 0.75rem; padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.08em; font-family: inherit; }
        .view-toggle button.active { color: #5ba3e6; border-bottom-color: #5ba3e6; }
        .view-toggle button:hover:not(.active) { color: #888; }

        /* ‚îÄ‚îÄ ECG Visualiser ‚îÄ‚îÄ */
        .visualiser-container { flex: 1; position: relative; background: #040804; display: none; overflow: hidden; }
        .visualiser-container.visible { display: block; }
        .transcript-container.hidden { display: none !important; }
        .ecg-canvas { width: 100%; height: 100%; display: block; }
        .monitor-overlay { position: absolute; top: 0; left: 0; right: 0; padding: 1rem 1.5rem; display: flex; justify-content: space-between; pointer-events: none; }
        .monitor-readout { font-family: 'SF Mono', 'Fira Code', monospace; }
        .monitor-readout .value { font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .monitor-readout .unit { font-size: 0.8rem; margin-left: 0.25rem; }
        .monitor-readout .label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.2rem; }
        .monitor-readout.hr .value { color: #00ff41; text-shadow: 0 0 20px #00ff4160; }
        .monitor-readout.hr .label, .monitor-readout.hr .unit { color: #00ff4180; }
        .monitor-readout.state { text-align: right; }
        .monitor-readout.state .value { font-size: 1rem; color: #5ba3e6; text-shadow: 0 0 10px #5ba3e640; }
        .monitor-readout.state .label { color: #5ba3e680; }
        .monitor-lead { position: absolute; bottom: 1rem; right: 1.5rem; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.9rem; color: #00ff4130; pointer-events: none; }

        /* ‚îÄ‚îÄ End Screen ‚îÄ‚îÄ */
        .end-screen { flex-direction: column; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; overflow-y: auto; }
        .end-icon { font-size: 3rem; margin-bottom: 1rem; margin-top: 2rem; }
        .end-screen h2 { font-size: 1.5rem; color: #fff; margin-bottom: 0.5rem; }
        .end-subtitle { color: #888; margin-bottom: 2rem; font-size: 1rem; }
        .end-stats { display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: center; }
        .stat-card { background: #1a1a1a; border: 1px solid #222; border-radius: 10px; padding: 1.25rem 1.5rem; min-width: 120px; }
        .stat-value { font-size: 1.5rem; color: #5ba3e6; font-weight: 700; font-family: 'SF Mono', monospace; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

        /* ‚îÄ‚îÄ Results Panel ‚îÄ‚îÄ */
        .results-panel { max-width: 600px; width: 100%; margin-bottom: 2rem; text-align: left; }
        .results-loading { text-align: center; color: #888; padding: 2rem; font-size: 0.9rem; }
        .results-loading .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #333; border-top-color: #5ba3e6; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .grade-card { background: #1a1a1a; border: 1px solid #222; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .grade-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .grade-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.25rem; }
        .grade-value.pass { color: #5ba3e6; }
        .grade-value.borderline { color: #e6a35b; }
        .grade-value.fail { color: #e65b5b; }
        .grade-justification { color: #aaa; font-size: 0.9rem; line-height: 1.5; }

        .topic-card { background: #1a1a1a; border: 1px solid #222; border-radius: 10px; padding: 1.25rem; margin-bottom: 0.75rem; }
        .topic-card h4 { color: #5ba3e6; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem; }
        .topic-card p { color: #bbb; font-size: 0.9rem; line-height: 1.5; }

        .improvement-card { background: #1a2020; border: 1px solid #2a3a2a; border-radius: 10px; padding: 1.25rem; margin-bottom: 0.75rem; }
        .improvement-card h4 { color: #e6a35b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem; }
        .improvement-card p { color: #bbb; font-size: 0.9rem; line-height: 1.5; }

        .criteria-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .criteria-item { background: #1a1a1a; border: 1px solid #222; border-radius: 8px; padding: 0.75rem; }
        .criteria-item .label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem; }
        .criteria-item .result { font-size: 0.85rem; font-weight: 600; }
        .criteria-item .result.success { color: #5be67a; }
        .criteria-item .result.failure { color: #e65b5b; }

        .end-actions { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .end-note { max-width: 450px; color: #666; font-size: 0.85rem; line-height: 1.6; padding-top: 1.5rem; border-top: 1px solid #222; }
        .end-topics { max-width: 450px; margin-bottom: 1.5rem; text-align: left; }
        .end-topics h3 { color: #aaa; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        .end-topics .topic-item { color: #5ba3e6; font-size: 0.95rem; margin-bottom: 0.25rem; }
        .footer-link { color: #444; font-size: 0.8rem; text-decoration: none; }

        /* ‚îÄ‚îÄ Review Modal ‚îÄ‚îÄ */
        #reviewModal { display:none; position:fixed; inset:0; background:#0a0a0aee; z-index:100; overflow-y:auto; padding:2rem; }
    </style>
</head>
<body>
    <!-- ‚ïê‚ïê‚ïê SCREEN 1: Entry ‚ïê‚ïê‚ïê -->
    <div class="screen entry-screen active" id="entryScreen">
        <div class="badge">Proof of Concept ‚Äî Primary FRCA SOE</div>
        <div class="logo">ü©∫</div>
        <h1>FRCA SOE Viva Simulator</h1>
        <p class="subtitle">AI-powered structured oral examination practice</p>
        <div class="name-form">
            <label for="candidateName">Enter your name</label>
            <input type="text" id="candidateName" placeholder="Dr. Smith" autocomplete="off" autofocus>
            <button class="btn" id="beginBtn">Begin Examination</button>
            <div class="mic-notice" id="micNotice">‚ö† Microphone access is required</div>
            <div class="error-notice" id="errorNotice"></div>
        </div>
        <div class="soe-selector">
            <div class="soe-option">
                <label>
                    <input type="radio" name="soePart" value="soe1" checked> SOE 1 ‚Äî Physiology &amp; Pharmacology
                </label>
            </div>
            <div class="soe-option">
                <label>
                    <input type="radio" name="soePart" value="soe2"> SOE 2 ‚Äî Clinical &amp; Physics
                </label>
            </div>
        </div>
        <div class="instructions-brief">
            <strong>How it works:</strong> Two examiners will each cover one topic for five minutes, mirroring one question from each section of the real Primary FRCA SOE.
            Speak naturally as you would in the exam. The examiners maintain a neutral, poker-face approach ‚Äî no feedback during the viva is normal.
            A live transcript appears on screen.
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN 2: Exam ‚ïê‚ïê‚ïê -->
    <div class="screen exam-screen" id="examScreen">
        <div class="exam-header">
            <div>
                <span class="candidate-name" id="displayName"></span>
                <span class="exam-title" id="examTitle"> ‚Äî Primary FRCA SOE 1</span>
            </div>
            <div class="examiner-indicator">
                <span class="examiner-badge" id="examinerBadge">Dr Whitmore</span>
                <div class="timer" id="timer">00:00</div>
            </div>
        </div>
        <div class="view-toggle">
            <button class="active" id="toggleTranscript">üìù Transcript</button>
            <button id="toggleMonitor">üíö Monitor</button>
        </div>
        <div class="transcript-container" id="transcript"></div>
        <div class="visualiser-container" id="visualiserContainer">
            <canvas class="ecg-canvas" id="ecgCanvas"></canvas>
            <div class="monitor-overlay">
                <div class="monitor-readout hr">
                    <div class="label">Engagement</div>
                    <div class="value"><span id="monitorHR">--</span><span class="unit">bpm</span></div>
                </div>
                <div class="monitor-readout state">
                    <div class="label">Status</div>
                    <div class="value" id="monitorState">Standby</div>
                </div>
            </div>
            <div class="monitor-lead">II</div>
        </div>
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn btn-danger" id="endBtn">End Examination</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SCREEN 3: Results ‚ïê‚ïê‚ïê -->
    <div class="screen end-screen" id="endScreen">
        <div class="end-icon">‚úÖ</div>
        <h2>Examination Complete</h2>
        <p class="end-subtitle" id="endSubtitle">Analysing your performance...</p>

        <div class="end-topics" id="endTopics"></div>

        <div class="end-stats">
            <div class="stat-card"><div class="stat-value" id="endDuration">--:--</div><div class="stat-label">Duration</div></div>
            <div class="stat-card"><div class="stat-value" id="endExchanges">0</div><div class="stat-label">Exchanges</div></div>
        </div>

        <!-- Results panel ‚Äî populated after fetching analysis -->
        <div class="results-panel" id="resultsPanel">
            <div class="results-loading" id="resultsLoading">
                <span class="spinner"></span> Generating your performance report...
            </div>
        </div>

        <div class="end-actions">
            <button class="btn" id="retryBtn">Try Again</button>
            <button class="btn btn-outline" id="reviewBtn">Review Transcript</button>
        </div>

        <div class="end-note">
            <strong>Note:</strong> Grades are AI-generated estimates based on examiner interaction.
            The neutral examiner demeanour mirrors the real Primary FRCA SOE ‚Äî no feedback during the viva is normal.
        </div>
        <p style="margin-top:1.5rem"><a href="https://databased.business" class="footer-link">databased.business</a></p>
    </div>

    <!-- ‚îÄ‚îÄ Transcript Review Modal ‚îÄ‚îÄ -->
    <div id="reviewModal"><div style="max-width:700px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h2 style="color:#fff;font-size:1.3rem;">Transcript Review</h2>
            <button class="btn btn-outline" id="closeReviewBtn" style="padding:0.4rem 1rem;font-size:0.85rem;">Close</button>
        </div>
        <div id="reviewContent"></div>
    </div></div>

    <script type="module">
        import { Conversation } from 'https://esm.sh/@elevenlabs/client';

        // ‚îÄ‚îÄ State ‚îÄ‚îÄ
        let conversation = null;
        let conversationId = null;
        let timerInterval = null;
        let seconds = 0;
        let exchangeCount = 0;
        let transcriptHistory = [];
        let scenarios = [];
        let selectedScenarios = [];
        let currentExaminer = 'Dr Whitmore';
        let examinerSwitched = false;
        let firstMessageReceived = false;

        /**
         * Domain pools matching the official RCoA Primary FRCA SOE structure.
         *
         * SOE 1 (morning): Examiner A = Pharmacology, Examiner B = Physiology
         * SOE 2 (afternoon): Examiner C = Clinical Anaesthesia, Examiner D = Physics/CM/Equipment/Safety
         *
         * Anatomy is NOT a standalone SOE section ‚Äî it appears cross-cuttingly
         * within physiology, clinical and physics questions. Scenarios tagged
         * 'anatomy' are placed in the physics/equipment pool for SOE 2.
         *
         * Source: RCoA Guide to the FRCA Examination ‚Äî The Primary, 4th ed.
         */
        const SOE_POOLS = {
            soe1: {
                label: 'SOE 1 ‚Äî Physiology & Pharmacology',
                examinerA: {
                    name: 'Dr Whitmore',
                    section: 'Pharmacology',
                    domains: new Set(['pharmacology'])
                },
                examinerB: {
                    name: 'Dr Harris',
                    section: 'Physiology',
                    domains: new Set(['physiology'])
                }
            },
            soe2: {
                label: 'SOE 2 ‚Äî Clinical & Physics',
                examinerA: {
                    name: 'Dr Whitmore',
                    section: 'Clinical Anaesthesia',
                    domains: new Set(['clinical_anaesthesia', 'critical_care', 'pain_medicine',
                        'critical_incidents', 'obstetric_anaesthesia', 'paediatric_anaesthesia',
                        'neuroanaesthesia', 'cardiothoracic', 'regional_anaesthesia'])
                },
                examinerB: {
                    name: 'Dr Harris',
                    section: 'Physics, Clinical Measurement, Equipment & Safety',
                    domains: new Set(['physics', 'clinical_measurement', 'equipment',
                        'anatomy'])
                }
            }
        };

        // ‚îÄ‚îÄ Load scenario bank ‚îÄ‚îÄ
        fetch('/scenarios.json').then(r => r.json()).then(data => {
            scenarios = data;
            console.log(`Loaded ${scenarios.length} scenarios`);
            checkPoolCoverage();
        });

        /**
         * Validate that every SOE part has at least one scenario in each
         * examiner pool. Disable radio buttons for any part that cannot
         * field both examiners, and auto-select the first available part.
         */
        function checkPoolCoverage() {
            let firstAvailable = null;
            let currentDisabled = false;

            for (const [key, pool] of Object.entries(SOE_POOLS)) {
                const radio = document.querySelector(`input[name="soePart"][value="${key}"]`);
                const label = radio?.closest('label');
                const wrapper = radio?.closest('.soe-option');
                if (!radio || !label || !wrapper) continue;

                const poolAEmpty = !scenarios.some(s => pool.examinerA.domains.has(s.domain));
                const poolBEmpty = !scenarios.some(s => pool.examinerB.domains.has(s.domain));

                // Remove any previous availability notice
                const prev = wrapper.querySelector('.pool-notice[data-soe="' + key + '"]');
                if (prev) prev.remove();

                if (poolAEmpty || poolBEmpty) {
                    radio.disabled = true;
                    label.classList.add('disabled');
                    if (radio.checked) currentDisabled = true;

                    const missing = [];
                    if (poolAEmpty) missing.push(pool.examinerA.section);
                    if (poolBEmpty) missing.push(pool.examinerB.section);

                    const notice = document.createElement('div');
                    notice.className = 'pool-notice';
                    notice.setAttribute('data-soe', key);
                    notice.textContent = `No ${missing.join(' or ')} scenarios available`;
                    wrapper.appendChild(notice);
                } else {
                    radio.disabled = false;
                    label.classList.remove('disabled');
                    if (!firstAvailable) firstAvailable = key;
                }
            }

            // If the currently checked part was disabled, switch to the first available
            if (currentDisabled && firstAvailable) {
                const fallbackRadio = document.querySelector(`input[name="soePart"][value="${firstAvailable}"]`);
                if (fallbackRadio) fallbackRadio.checked = true;
            }

            // If NO part is available, disable the Begin button entirely
            const anyAvailable = document.querySelector('input[name="soePart"]:not(:disabled)');
            const beginBtn = document.getElementById('beginBtn');
            const errEl = document.getElementById('errorNotice');
            if (!anyAvailable) {
                beginBtn.disabled = true;
                errEl.textContent = '‚ö† No SOE part has full domain coverage. Add scenarios to enable practice.';
                errEl.style.display = 'block';
            } else {
                // Clear error only if it was set by us (not by something else)
                if (errEl.textContent.includes('No SOE part has full domain coverage')) {
                    errEl.style.display = 'none';
                }
            }
        }

        function getSelectedSOEPart() {
            const radio = document.querySelector('input[name="soePart"]:checked');
            return radio ? radio.value : 'soe1';
        }

        function pickTwo(soePart) {
            const pools = SOE_POOLS[soePart];
            const poolA = scenarios.filter(s => pools.examinerA.domains.has(s.domain));
            const poolB = scenarios.filter(s => pools.examinerB.domains.has(s.domain));

            // Fail fast: never silently cross domains
            if (poolA.length === 0 || poolB.length === 0) {
                const empty = [];
                if (poolA.length === 0) empty.push(pools.examinerA.section);
                if (poolB.length === 0) empty.push(pools.examinerB.section);
                throw new Error(
                    `Cannot start ${pools.label}: no scenarios available for ${empty.join(' or ')}.`
                );
            }

            const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
            const s1 = shuffle(poolA)[0];

            // Try to find a case-paired scenario in poolB
            let s2 = null;
            if (s1.caseId) {
                s2 = shuffle(poolB).find(s => s.caseId === s1.caseId && s.id !== s1.id);
            }
            if (!s2) s2 = shuffle(poolB)[0];

            return { scenarios: [s1, s2], pools };
        }

        // ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function addMsg(text, role, examiner) {
            const container = document.getElementById('transcript');
            const msg = document.createElement('div');
            msg.className = 'transcript-msg ' + role;
            if (role === 'examiner') msg.setAttribute('data-examiner', examiner || 'Examiner');
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            transcriptHistory.push({ text, role, examiner, time: seconds });
            if (role === 'candidate') exchangeCount++;
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusText');
            dot.className = 'status-dot';
            if (state) dot.classList.add(state);
            label.textContent = text || '';
        }

        function updateExaminerBadge(name) {
            document.getElementById('examinerBadge').textContent = name;
        }

        function fmt(s) {
            return Math.floor(s / 60).toString().padStart(2, '0') + ':' + (s % 60).toString().padStart(2, '0');
        }

        function checkExaminerSwitch(text) {
            if (examinerSwitched) return;
            if (!firstMessageReceived) { firstMessageReceived = true; return; }
            const handoverPhrases = [
                'colleague will now continue', 'colleague will continue',
                'my colleague', 'concludes my section', 'that concludes my',
                'I am Dr Harris', "I'm Dr Harris", 'over to you'
            ];
            const lower = text.toLowerCase();
            if (handoverPhrases.some(p => lower.includes(p.toLowerCase()))) {
                examinerSwitched = true;
                currentExaminer = 'Dr Harris';
                updateExaminerBadge('Dr Harris');
                addMsg('Examiner handover ‚Äî Dr Harris now examining', 'system');
            }
        }

        // ‚îÄ‚îÄ ECG Monitor ‚îÄ‚îÄ
        class ECGMonitor {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas ? this.canvas.getContext('2d') : null;
                this.running = false;
                this.activity = 0;
                this.targetActivity = 0;
                this.heartRate = 35;
                this.phase = 0;
                this.sweepX = 0;
                this.buffer = [];
                this.lastTime = 0;
                this.w = 0;
                this.h = 0;
            }

            // Realistic PQRST complex ‚Äî Lead II morphology
            pqrst(t) {
                if (t < 0.10) return 0.12 * Math.sin(Math.PI * t / 0.10);       // P wave
                if (t < 0.14) return 0;                                          // PR segment
                if (t < 0.17) return -0.08 * Math.sin(Math.PI * (t - 0.14) / 0.03); // Q
                if (t < 0.22) return Math.sin(Math.PI * (t - 0.17) / 0.05);     // R peak
                if (t < 0.27) return -0.20 * Math.sin(Math.PI * (t - 0.22) / 0.05); // S
                if (t < 0.36) return 0.02;                                       // ST segment
                if (t < 0.52) return 0.25 * Math.sin(Math.PI * (t - 0.36) / 0.16); // T wave
                return 0;                                                        // baseline
            }

            // Slow delta-wave pattern for low-activity state (anaesthetic depth metaphor)
            deltaWave(t) {
                return 0.06 * Math.sin(2 * Math.PI * t) + 0.025 * Math.sin(4.7 * Math.PI * t);
            }

            resize() {
                if (!this.canvas) return;
                const rect = this.canvas.parentElement.getBoundingClientRect();
                if (rect.width === 0 || rect.height === 0) return;
                const dpr = window.devicePixelRatio || 1;
                this.w = rect.width;
                this.h = rect.height;
                this.canvas.width = this.w * dpr;
                this.canvas.height = this.h * dpr;
                this.canvas.style.width = this.w + 'px';
                this.canvas.style.height = this.h + 'px';
                this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                const len = Math.ceil(this.w);
                if (this.buffer.length !== len) this.buffer = new Array(len).fill(0);
            }

            setActivity(level) {
                this.targetActivity = Math.max(0, Math.min(1, level));
            }

            start() {
                if (!this.canvas || this.running) return;
                this.running = true;
                this.resize();
                this.lastTime = performance.now();
                this._frame();
            }

            stop() { this.running = false; }

            reset() {
                this.stop();
                this.sweepX = 0;
                this.phase = 0;
                this.activity = 0;
                this.targetActivity = 0;
                this.heartRate = 35;
                if (this.buffer.length) this.buffer.fill(0);
            }

            _frame() {
                if (!this.running) return;
                const now = performance.now();
                const dt = Math.min((now - this.lastTime) / 1000, 0.05);
                this.lastTime = now;

                // Smooth transitions
                this.activity += (this.targetActivity - this.activity) * 2.5 * dt;
                const thr = 35 + this.activity * 60;
                this.heartRate += (thr - this.heartRate) * 2.0 * dt;

                // Advance sweep head ‚Äî 4-second sweep across canvas
                const spd = this.w / 4;
                const adv = spd * dt;
                const from = Math.floor(this.sweepX);
                const to = Math.floor(this.sweepX + adv);
                const bps = this.heartRate / 60;
                const ppx = bps / spd;

                for (let i = from; i <= to; i++) {
                    const px = i % this.buffer.length;
                    this.phase += ppx;
                    if (this.phase >= 1) this.phase -= Math.floor(this.phase);
                    const e = this.pqrst(this.phase);
                    const d = this.deltaWave(this.phase * 0.25);
                    const a = this.activity;
                    this.buffer[px] = (e * a + d * (1 - a)) * (0.4 + a * 0.6)
                        + (Math.random() - 0.5) * 0.012;
                }
                this.sweepX = (this.sweepX + adv) % this.w;

                // Update monitor readouts
                const hrEl = document.getElementById('monitorHR');
                if (hrEl) hrEl.textContent = Math.round(this.heartRate);
                const stEl = document.getElementById('monitorState');
                if (stEl) stEl.textContent = this.activity > 0.6 ? 'Responding'
                    : this.activity > 0.2 ? 'Listening' : 'Standby';

                this._draw();
                requestAnimationFrame(() => this._frame());
            }

            _draw() {
                const ctx = this.ctx, w = this.w, h = this.h;
                if (!ctx || w === 0) return;
                const midY = h * 0.5, amp = h * 0.35;
                const sweep = Math.floor(this.sweepX);
                const gap = Math.max(12, w * 0.025);

                // Dark background
                ctx.fillStyle = '#040804';
                ctx.fillRect(0, 0, w, h);

                // Grid ‚Äî major (50px)
                ctx.strokeStyle = '#0a1a0a';
                ctx.lineWidth = 1;
                ctx.beginPath();
                for (let x = 0; x < w; x += 50) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
                for (let y = 0; y < h; y += 50) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();

                // Grid ‚Äî minor (10px)
                ctx.strokeStyle = '#060e06';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                for (let x = 0; x < w; x += 10) { ctx.moveTo(x, 0); ctx.lineTo(x, h); }
                for (let y = 0; y < h; y += 10) { ctx.moveTo(0, y); ctx.lineTo(w, y); }
                ctx.stroke();

                // Trace ‚Äî phosphor glow pass
                ctx.save();
                ctx.shadowColor = '#00ff41';
                ctx.shadowBlur = 15;
                ctx.strokeStyle = '#00ff41';
                ctx.lineWidth = 2.2;
                this._trace(ctx, midY, amp, sweep, gap);
                ctx.restore();

                // Trace ‚Äî bright core
                ctx.strokeStyle = '#50ff90';
                ctx.lineWidth = 1.0;
                this._trace(ctx, midY, amp, sweep, gap);

                // Sweep head dot
                const sy = midY - (this.buffer[sweep] || 0) * amp;
                ctx.beginPath();
                ctx.arc(sweep, sy, 3, 0, 2 * Math.PI);
                ctx.fillStyle = '#a0ffc0';
                ctx.shadowColor = '#00ff41';
                ctx.shadowBlur = 18;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            _trace(ctx, midY, amp, sweep, gap) {
                const len = this.buffer.length;
                ctx.beginPath();
                let pen = false;
                for (let i = 0; i < len; i++) {
                    const dist = (i - sweep + len) % len;
                    if (dist > 0 && dist < gap) { pen = false; continue; }
                    const y = midY - this.buffer[i] * amp;
                    if (!pen) { ctx.moveTo(i, y); pen = true; } else { ctx.lineTo(i, y); }
                }
                ctx.stroke();
            }
        }

        const ecg = new ECGMonitor('ecgCanvas');

        function setExamView(view) {
            const trans = document.getElementById('transcript');
            const vis = document.getElementById('visualiserContainer');
            const btnT = document.getElementById('toggleTranscript');
            const btnM = document.getElementById('toggleMonitor');
            if (view === 'monitor') {
                trans.classList.add('hidden');
                vis.classList.add('visible');
                btnT.classList.remove('active');
                btnM.classList.add('active');
                ecg.resize();
                ecg.start();
            } else {
                trans.classList.remove('hidden');
                vis.classList.remove('visible');
                btnT.classList.add('active');
                btnM.classList.remove('active');
                ecg.stop();
            }
        }

        document.getElementById('toggleTranscript').addEventListener('click', () => setExamView('transcript'));
        document.getElementById('toggleMonitor').addEventListener('click', () => setExamView('monitor'));
        window.addEventListener('resize', () => { if (ecg.running) ecg.resize(); });

        // ‚îÄ‚îÄ Results fetching ‚îÄ‚îÄ
        async function fetchResults(convId, retries = 10) {
            for (let i = 0; i < retries; i++) {
                await new Promise(r => setTimeout(r, 3000)); // Wait 3s between attempts
                try {
                    const resp = await fetch(`/api/results/${convId}`);
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    if (data.analysis && data.analysis.data_collection_results) {
                        return data.analysis;
                    }
                } catch (e) {
                    console.log('Results not ready yet, retrying...', e);
                }
            }
            return null;
        }

        function renderResults(analysis) {
            const panel = document.getElementById('resultsPanel');
            const loading = document.getElementById('resultsLoading');

            if (!analysis) {
                loading.innerHTML = '‚ö† Could not retrieve performance analysis. Review the transcript instead.';
                return;
            }

            // data_collection_results is keyed by id, each has .value
            const dcRaw = analysis.data_collection_results || {};
            const dc = {};
            for (const [k, v] of Object.entries(dcRaw)) {
                dc[k] = typeof v === 'object' ? (v.value || '') : v;
            }
            const eval_ = analysis.evaluation_criteria_results || {};

            let html = '';

            // Per-question grade cards ‚Äî RCoA 0/1/2 marking
            // The agent returns "2 ‚Äî justification", "1 ‚Äî ‚Ä¶", "0 ‚Äî ‚Ä¶" per question.
            function mapQuestionMark(raw) {
                if (!raw) return null;
                const s = raw.trim();
                // Primary match: leading digit 0‚Äì2
                const numMatch = s.match(/^([0-2])\b/);
                if (numMatch) {
                    const n = numMatch[1];
                    return { '2': { label: '2 ‚Äî Pass',       css: 'pass' },
                             '1': { label: '1 ‚Äî Borderline', css: 'borderline' },
                             '0': { label: '0 ‚Äî Fail',       css: 'fail' } }[n];
                }
                // Fallback: first word may be a grade label (case-insensitive)
                const word = s.split(/[\s.,:;\u2014\u2013+/-]+/)[0].toUpperCase();
                const textMap = {
                    'PASS':       { label: '2 ‚Äî Pass',       css: 'pass' },
                    'BORDERLINE': { label: '1 ‚Äî Borderline', css: 'borderline' },
                    'FAIL':       { label: '0 ‚Äî Fail',       css: 'fail' },
                };
                return textMap[word] || null;
            }
            function renderQuestionCard(raw, label) {
                if (!raw) return '';
                const mapped = mapQuestionMark(raw);
                const display = mapped || { label: raw, css: '' };
                // Strip the matched mark token from the start to isolate justification
                const justification = mapped
                    ? raw.replace(/^[0-2]\s*[\u2014\u2013\-‚Äî]\s*/, '')
                         .replace(/^(pass|borderline|fail)\s*[\u2014\u2013\-‚Äî:.\s]*/i, '')
                    : '';
                return `<div class="grade-card">
                    <div class="grade-label">${label}</div>
                    <div class="grade-value ${display.css}">${display.label}</div>
                    ${justification ? `<div class="grade-justification">${justification}</div>` : ''}
                </div>`;
            }
            const q1Raw = (dc.question_1_mark || '').trim();
            const q2Raw = (dc.question_2_mark || '').trim();
            html += renderQuestionCard(q1Raw, 'Question 1 ‚Äî Dr Whitmore (RCoA mark)');
            html += renderQuestionCard(q2Raw, 'Question 2 ‚Äî Dr Harris (RCoA mark)');

            // Evaluation criteria grid
            if (eval_ && Object.keys(eval_).length > 0) {
                html += '<div class="criteria-grid">';
                const criteriaList = Array.isArray(eval_) ? eval_ : Object.values(eval_);
                for (const c of criteriaList) {
                    const name = (c.criteria_id || c.name || '').replace(/_/g, ' ');
                    const result = c.result || 'unknown';
                    const cls = result === 'success' ? 'success' : 'failure';
                    html += `<div class="criteria-item">
                        <div class="label">${name}</div>
                        <div class="result ${cls}">${result === 'success' ? '‚úì Pass' : '‚úó Needs work'}</div>
                    </div>`;
                }
                html += '</div>';
            }

            // Topic summaries
            // Use dynamic section labels from active SOE pools
            const activeSOE = SOE_POOLS[getSelectedSOEPart()];
            if (dc.topic_1_summary) {
                html += `<div class="topic-card">
                    <h4>${activeSOE.examinerA.name} ‚Äî ${activeSOE.examinerA.section}</h4>
                    <p>${dc.topic_1_summary}</p>
                </div>`;
            }
            if (dc.topic_2_summary) {
                html += `<div class="topic-card">
                    <h4>${activeSOE.examinerB.name} ‚Äî ${activeSOE.examinerB.section}</h4>
                    <p>${dc.topic_2_summary}</p>
                </div>`;
            }

            // Areas for improvement
            if (dc.areas_for_improvement) {
                html += `<div class="improvement-card">
                    <h4>üìö Areas for Revision</h4>
                    <p>${dc.areas_for_improvement}</p>
                </div>`;
            }

            loading.style.display = 'none';
            panel.innerHTML += html;
        }

        // ‚îÄ‚îÄ End screen ‚îÄ‚îÄ
        async function showEnd() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            ecg.stop();
            setExamView('transcript');
            document.getElementById('endDuration').textContent = fmt(seconds);
            document.getElementById('endExchanges').textContent = exchangeCount;

            const topicsEl = document.getElementById('endTopics');
            const soePart = getSelectedSOEPart();
            const pools = SOE_POOLS[soePart];
            topicsEl.innerHTML = '<h3>Topics Examined</h3>' +
                selectedScenarios.map((s, i) => {
                    const ex = i === 0 ? pools.examinerA : pools.examinerB;
                    return `<div class="topic-item">${ex.name} (${ex.section}): ${s.topic}</div>`;
                }).join('');

            // Log session data (future: persist to tracking API)
            const sessionData = {
                soePart: getSelectedSOEPart(),
                scenarioIds: selectedScenarios.map(s => s.id),
                topics: selectedScenarios.map(s => s.topic),
                domains: selectedScenarios.map(s => s.domain),
                caseIds: selectedScenarios.map(s => s.caseId),
                duration: seconds,
                exchanges: exchangeCount,
                transcript: transcriptHistory,
                conversationId: conversationId,
                timestamp: new Date().toISOString()
            };
            console.log('Session result:', sessionData);

            showScreen('endScreen');

            // Fetch and render results
            if (conversationId) {
                document.getElementById('endSubtitle').textContent = 'Analysing your performance...';
                const analysis = await fetchResults(conversationId);
                renderResults(analysis);
                document.getElementById('endSubtitle').textContent = 'Your viva session has concluded.';
            }
        }

        // ‚îÄ‚îÄ Begin Examination ‚îÄ‚îÄ
        document.getElementById('beginBtn').addEventListener('click', async () => {
            const name = document.getElementById('candidateName').value.trim();
            if (!name) { document.getElementById('candidateName').focus(); return; }
            if (scenarios.length === 0) {
                document.getElementById('errorNotice').textContent = '‚ö† Loading scenarios...';
                document.getElementById('errorNotice').style.display = 'block';
                return;
            }

            const btn = document.getElementById('beginBtn');
            const errEl = document.getElementById('errorNotice');
            errEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Connecting...';

            try { await navigator.mediaDevices.getUserMedia({ audio: true }); }
            catch (e) {
                document.getElementById('micNotice').style.display = 'block';
                btn.disabled = false; btn.textContent = 'Begin Examination'; return;
            }

            const soePart = getSelectedSOEPart();
            let pick;
            try {
                pick = pickTwo(soePart);
            } catch (e) {
                errEl.textContent = '‚ö† ' + e.message;
                errEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Begin Examination';
                return;
            }
            selectedScenarios = pick.scenarios;
            const activePools = pick.pools;
            const s1 = selectedScenarios[0];
            const s2 = selectedScenarios[1];

            // Build structured prompt block for each scenario
            function formatPromptsBlock(scenario) {
                if (!scenario.prompts || scenario.prompts.length === 0) {
                    // Fallback: old-style flat data, or empty if neither exists
                    return scenario.probes ? scenario.probes.join('; ') : '';
                }
                return scenario.prompts.map((p, i) => {
                    const tier = (p.tier || 'general').toUpperCase();
                    const time = p.timeBudgetSec ? ` (~${p.timeBudgetSec}s)` : '';
                    const facts = (p.expectedKeyFacts || []).join('; ');
                    return `[${tier}${time}] ${p.text}\nExpected: ${facts}`;
                }).join('\n\n');
            }

            function formatScoring(sg) {
                if (!sg) return '';
                return `Pass(2): ${sg.pass}\nBorderline(1): ${sg.borderline}\nFail(0): ${sg.fail}`;
            }

            const dynamicVars = {
                candidate_name: name.split(' ').pop(),
                // SOE part context
                soe_part: soePart === 'soe1' ? 'SOE 1 ‚Äî Physiology & Pharmacology' : 'SOE 2 ‚Äî Clinical Anaesthesia, Physics & Equipment',
                examiner_1_section: activePools.examinerA.section,
                examiner_2_section: activePools.examinerB.section,
                // Scenario 1 ‚Äî Examiner A
                scenario_1_topic: s1.topic,
                scenario_1_opening: s1.opening,
                scenario_1_points: s1.points.join('; '),
                scenario_1_probes: formatPromptsBlock(s1),
                scenario_1_facts: s1.facts.join('; '),
                scenario_1_rescue: s1.rescue || 'Simplify the question',
                scenario_1_scoring: formatScoring(s1.scoringGuidance),
                // Scenario 2 ‚Äî Examiner B
                scenario_2_topic: s2.topic,
                scenario_2_opening: s2.opening,
                scenario_2_points: s2.points.join('; '),
                scenario_2_probes: formatPromptsBlock(s2),
                scenario_2_facts: s2.facts.join('; '),
                scenario_2_rescue: s2.rescue || 'Simplify the question',
                scenario_2_scoring: formatScoring(s2.scoringGuidance)
            };

            try {
                conversation = await Conversation.startSession({
                    agentId: 'agent_7401kgyecx7mewbv2c8gs5f0ff39',
                    connectionType: 'webrtc',
                    dynamicVariables: dynamicVars,
                    onConnect: () => {
                        updateStatus('connected', 'Connected');
                    },
                    onDisconnect: () => showEnd(),
                    onMessage: (msg) => {
                        if (msg.source === 'ai' && !msg.isTentative) {
                            checkExaminerSwitch(msg.message);
                            addMsg(msg.message, 'examiner', currentExaminer);
                            updateStatus('speaking', currentExaminer + ' is speaking...');
                        } else if (msg.source === 'user' && !msg.isTentative) {
                            addMsg(msg.message, 'candidate');
                            updateStatus('listening', 'Listening...');
                        }
                    },
                    onModeChange: (mode) => {
                        if (mode.mode === 'listening') {
                            updateStatus('listening', 'Listening...');
                            ecg.setActivity(1.0);
                        } else if (mode.mode === 'speaking') {
                            updateStatus('speaking', currentExaminer + ' is speaking...');
                            ecg.setActivity(0.3);
                        }
                    },
                    onError: (err) => console.error('EL error:', err)
                });

                // Extract conversation ID from the connection/room name
                // Room name format: room_agent_{agentId}_conv_{convId}
                try {
                    const connStr = JSON.stringify(conversation.connection || {});
                    const convMatch = connStr.match(/conv_[a-z0-9]+/);
                    if (convMatch) conversationId = convMatch[0];
                    console.log('Conversation ID from connection:', conversationId);
                } catch (e) {
                    console.log('Could not extract conversation ID:', e);
                }

                document.getElementById('displayName').textContent = name;
                showScreen('examScreen');
                console.log('SCENARIO 1:', selectedScenarios[0].topic, '| SCENARIO 2:', selectedScenarios[1].topic);
                document.title = selectedScenarios[0].topic.substring(0, 30) + ' / ' + selectedScenarios[1].topic.substring(0, 30);
                seconds = 0;
                exchangeCount = 0;
                transcriptHistory = [];
                currentExaminer = 'Dr Whitmore';
                examinerSwitched = false;
                firstMessageReceived = false;
                updateExaminerBadge('Dr Whitmore');
                document.getElementById('transcript').innerHTML = '';
                document.getElementById('resultsPanel').innerHTML = '<div class="results-loading" id="resultsLoading"><span class="spinner"></span> Generating your performance report...</div>';

                // Update exam header to reflect selected SOE part
                document.getElementById('examTitle').textContent = ' ‚Äî Primary FRCA ' + activePools.label;

                timerInterval = setInterval(() => {
                    seconds++;
                    const el = document.getElementById('timer');
                    el.textContent = fmt(seconds);
                    // 5 min per topic √ó 2 = 10 min session; warn at 8 min, critical at 9:30
                    if (seconds >= 570) { el.classList.add('critical'); el.classList.remove('warning'); }
                    else if (seconds >= 480) { el.classList.add('warning'); }
                }, 1000);
            } catch (e) {
                console.error('Start failed:', e);
                errEl.textContent = '‚ö† Connection failed: ' + e.message;
                errEl.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Begin Examination';
            }
        });

        // ‚îÄ‚îÄ Controls ‚îÄ‚îÄ
        document.getElementById('endBtn').addEventListener('click', async () => {
            if (conversation) { await conversation.endSession(); conversation = null; }
            showEnd();
        });

        document.getElementById('retryBtn').addEventListener('click', () => {
            document.getElementById('beginBtn').disabled = false;
            document.getElementById('beginBtn').textContent = 'Begin Examination';
            document.getElementById('timer').className = 'timer';
            currentExaminer = 'Dr Whitmore';
            examinerSwitched = false;
            firstMessageReceived = false;
            conversationId = null;
            updateExaminerBadge('Dr Whitmore');
            ecg.reset();
            setExamView('transcript');
            showScreen('entryScreen');
        });

        document.getElementById('reviewBtn').addEventListener('click', () => {
            document.getElementById('reviewContent').innerHTML = transcriptHistory.map(t =>
                '<div class="transcript-msg ' + t.role + '"' +
                (t.role === 'examiner' ? ' data-examiner="' + t.examiner + '"' : '') +
                ' style="margin-bottom:0.5rem;">' +
                '<span style="color:#555;font-size:0.7rem;">' + fmt(t.time) + '</span> ' +
                t.text + '</div>'
            ).join('');
            document.getElementById('reviewModal').style.display = 'block';
        });

        document.getElementById('closeReviewBtn').addEventListener('click', () => {
            document.getElementById('reviewModal').style.display = 'none';
        });

        document.getElementById('candidateName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('beginBtn').click();
        });
    </script>
</body>
</html>
