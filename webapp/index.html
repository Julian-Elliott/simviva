<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRCA SOE Viva Simulator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; min-height: 100vh; }
        .screen { display: none; }
        .screen.active { display: flex; }

        /* â”€â”€ Entry Screen â”€â”€ */
        .entry-screen { flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; }
        .logo { font-size: 2.5rem; margin-bottom: 0.5rem; }
        h1 { font-size: 2rem; color: #fff; margin-bottom: 0.25rem; }
        .subtitle { color: #888; margin-bottom: 2.5rem; font-size: 1.1rem; }
        .badge { display: inline-block; background: #1e3a5f; color: #5ba3e6; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .name-form { display: flex; flex-direction: column; align-items: center; gap: 1rem; width: 100%; max-width: 400px; }
        .name-form label { font-size: 0.9rem; color: #aaa; text-transform: uppercase; letter-spacing: 0.05em; }
        .name-form input { width: 100%; padding: 0.75rem 1rem; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 1.1rem; text-align: center; outline: none; }
        .name-form input:focus { border-color: #5ba3e6; }
        .name-form input::placeholder { color: #555; }
        .btn { padding: 0.75rem 2.5rem; background: #5ba3e6; color: #fff; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: all 0.2s; }
        .btn:hover { background: #4a8fd4; }
        .btn:disabled { background: #333; cursor: not-allowed; color: #666; }
        .btn-outline { background: transparent; border: 1px solid #5ba3e6; color: #5ba3e6; }
        .btn-outline:hover { background: #5ba3e610; }
        .btn-danger { background: #3a1a1a; color: #e65b5b; border: 1px solid #5b2a2a; padding: 0.5rem 1.25rem; font-size: 0.85rem; }
        .btn-danger:hover { background: #4a2020; }
        .instructions-brief { max-width: 400px; margin-top: 2rem; padding: 1.25rem; background: #1a1a1a; border: 1px solid #222; border-radius: 10px; font-size: 0.85rem; color: #888; line-height: 1.6; }
        .instructions-brief strong { color: #bbb; }
        .error-notice { color: #e65b5b; font-size: 0.8rem; margin-top: 0.5rem; display: none; }
        .mic-notice { color: #e6a35b; font-size: 0.8rem; margin-top: 0.5rem; display: none; }

        /* â”€â”€ Exam Screen â”€â”€ */
        .exam-screen { flex-direction: column; height: 100vh; }
        .exam-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: #111; border-bottom: 1px solid #222; }
        .candidate-name { color: #5ba3e6; font-weight: 600; }
        .exam-title { color: #888; font-size: 0.9rem; }
        .timer { font-family: 'SF Mono', 'Fira Code', monospace; color: #5ba3e6; font-size: 1.1rem; background: #1a1a1a; padding: 0.3rem 0.75rem; border-radius: 6px; border: 1px solid #333; }
        .timer.warning { color: #e6a35b; border-color: #e6a35b; }
        .timer.critical { color: #e65b5b; border-color: #e65b5b; }
        .examiner-indicator { display: flex; align-items: center; gap: 0.5rem; }
        .examiner-badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 4px; background: #1a2a3a; color: #5ba3e6; font-weight: 600; }
        .transcript-container { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .transcript-msg { max-width: 80%; padding: 0.75rem 1rem; border-radius: 12px; line-height: 1.5; font-size: 0.95rem; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .transcript-msg.examiner { background: #1a2a3a; color: #d0e0f0; align-self: flex-start; border-bottom-left-radius: 4px; }
        .transcript-msg.examiner::before { content: attr(data-examiner); display: block; font-size: 0.7rem; color: #5ba3e6; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .transcript-msg.candidate { background: #2a2a2a; color: #ccc; align-self: flex-end; border-bottom-right-radius: 4px; }
        .transcript-msg.candidate::before { content: 'You'; display: block; font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; text-align: right; }
        .transcript-msg.system { align-self: center; background: none; color: #555; font-size: 0.8rem; font-style: italic; }
        .status-bar { padding: 0.75rem 1.5rem; background: #111; border-top: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #888; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
        .status-dot.listening { background: #5be67a; animation: pulse 1.5s infinite; }
        .status-dot.speaking { background: #5ba3e6; animation: pulse 1s infinite; }
        .status-dot.connected { background: #5be67a; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* â”€â”€ End Screen â”€â”€ */
        .end-screen { flex-direction: column; align-items: center; min-height: 100vh; padding: 2rem; text-align: center; overflow-y: auto; }
        .end-icon { font-size: 3rem; margin-bottom: 1rem; margin-top: 2rem; }
        .end-screen h2 { font-size: 1.5rem; color: #fff; margin-bottom: 0.5rem; }
        .end-subtitle { color: #888; margin-bottom: 2rem; font-size: 1rem; }
        .end-stats { display: flex; gap: 2rem; margin-bottom: 2rem; flex-wrap: wrap; justify-content: center; }
        .stat-card { background: #1a1a1a; border: 1px solid #222; border-radius: 10px; padding: 1.25rem 1.5rem; min-width: 120px; }
        .stat-value { font-size: 1.5rem; color: #5ba3e6; font-weight: 700; font-family: 'SF Mono', monospace; }
        .stat-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.25rem; }

        /* â”€â”€ Results Panel â”€â”€ */
        .results-panel { max-width: 600px; width: 100%; margin-bottom: 2rem; text-align: left; }
        .results-loading { text-align: center; color: #888; padding: 2rem; font-size: 0.9rem; }
        .results-loading .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #333; border-top-color: #5ba3e6; border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 0.5rem; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .grade-card { background: #1a1a1a; border: 1px solid #222; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
        .grade-label { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .grade-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.25rem; }
        .grade-value.distinction { color: #5be67a; }
        .grade-value.pass { color: #5ba3e6; }
        .grade-value.borderline { color: #e6a35b; }
        .grade-value.fail { color: #e65b5b; }
        .grade-justification { color: #aaa; font-size: 0.9rem; line-height: 1.5; }

        .topic-card { background: #1a1a1a; border: 1px solid #222; border-radius: 10px; padding: 1.25rem; margin-bottom: 0.75rem; }
        .topic-card h4 { color: #5ba3e6; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem; }
        .topic-card p { color: #bbb; font-size: 0.9rem; line-height: 1.5; }

        .improvement-card { background: #1a2020; border: 1px solid #2a3a2a; border-radius: 10px; padding: 1.25rem; margin-bottom: 0.75rem; }
        .improvement-card h4 { color: #e6a35b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 0.5rem; }
        .improvement-card p { color: #bbb; font-size: 0.9rem; line-height: 1.5; }

        .criteria-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .criteria-item { background: #1a1a1a; border: 1px solid #222; border-radius: 8px; padding: 0.75rem; }
        .criteria-item .label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 0.25rem; }
        .criteria-item .result { font-size: 0.85rem; font-weight: 600; }
        .criteria-item .result.success { color: #5be67a; }
        .criteria-item .result.failure { color: #e65b5b; }

        .end-actions { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .end-note { max-width: 450px; color: #666; font-size: 0.85rem; line-height: 1.6; padding-top: 1.5rem; border-top: 1px solid #222; }
        .end-topics { max-width: 450px; margin-bottom: 1.5rem; text-align: left; }
        .end-topics h3 { color: #aaa; font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        .end-topics .topic-item { color: #5ba3e6; font-size: 0.95rem; margin-bottom: 0.25rem; }
        .footer-link { color: #444; font-size: 0.8rem; text-decoration: none; }

        /* â”€â”€ Review Modal â”€â”€ */
        #reviewModal { display:none; position:fixed; inset:0; background:#0a0a0aee; z-index:100; overflow-y:auto; padding:2rem; }
    </style>
</head>
<body>
    <!-- â•â•â• SCREEN 1: Entry â•â•â• -->
    <div class="screen entry-screen active" id="entryScreen">
        <div class="badge">Proof of Concept â€” Final FRCA SOE</div>
        <div class="logo">ðŸ©º</div>
        <h1>FRCA SOE Viva Simulator</h1>
        <p class="subtitle">AI-powered structured oral examination practice</p>
        <div class="name-form">
            <label for="candidateName">Enter your name</label>
            <input type="text" id="candidateName" placeholder="Dr. Smith" autocomplete="off" autofocus>
            <button class="btn" id="beginBtn">Begin Examination</button>
            <div class="mic-notice" id="micNotice">âš  Microphone access is required</div>
            <div class="error-notice" id="errorNotice"></div>
        </div>
        <div class="instructions-brief">
            <strong>How it works:</strong> Two examiners â€” Dr Whitmore and Dr Harris â€” will each present a clinical scenario.
            Speak naturally as you would in a real Final FRCA viva. The examiners maintain a neutral, poker-face approach.
            A live transcript appears on screen. The station lasts approximately 15 minutes.
        </div>
    </div>

    <!-- â•â•â• SCREEN 2: Exam â•â•â• -->
    <div class="screen exam-screen" id="examScreen">
        <div class="exam-header">
            <div>
                <span class="candidate-name" id="displayName"></span>
                <span class="exam-title"> â€” Final FRCA SOE</span>
            </div>
            <div class="examiner-indicator">
                <span class="examiner-badge" id="examinerBadge">Dr Whitmore</span>
                <div class="timer" id="timer">00:00</div>
            </div>
        </div>
        <div class="transcript-container" id="transcript"></div>
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn btn-danger" id="endBtn">End Examination</button>
        </div>
    </div>

    <!-- â•â•â• SCREEN 3: Results â•â•â• -->
    <div class="screen end-screen" id="endScreen">
        <div class="end-icon">âœ…</div>
        <h2>Examination Complete</h2>
        <p class="end-subtitle" id="endSubtitle">Analysing your performance...</p>

        <div class="end-topics" id="endTopics"></div>

        <div class="end-stats">
            <div class="stat-card"><div class="stat-value" id="endDuration">--:--</div><div class="stat-label">Duration</div></div>
            <div class="stat-card"><div class="stat-value" id="endExchanges">0</div><div class="stat-label">Exchanges</div></div>
        </div>

        <!-- Results panel â€” populated after fetching analysis -->
        <div class="results-panel" id="resultsPanel">
            <div class="results-loading" id="resultsLoading">
                <span class="spinner"></span> Generating your performance report...
            </div>
        </div>

        <div class="end-actions">
            <button class="btn" id="retryBtn">Try Again</button>
            <button class="btn btn-outline" id="reviewBtn">Review Transcript</button>
        </div>

        <div class="end-note">
            <strong>Note:</strong> Grades are AI-generated estimates based on examiner interaction.
            The neutral examiner demeanour mirrors the real Final FRCA SOE â€” no feedback during the exam is normal.
        </div>
        <p style="margin-top:1.5rem"><a href="https://databased.business" class="footer-link">databased.business</a></p>
    </div>

    <!-- â”€â”€ Transcript Review Modal â”€â”€ -->
    <div id="reviewModal"><div style="max-width:700px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
            <h2 style="color:#fff;font-size:1.3rem;">Transcript Review</h2>
            <button class="btn btn-outline" id="closeReviewBtn" style="padding:0.4rem 1rem;font-size:0.85rem;">Close</button>
        </div>
        <div id="reviewContent"></div>
    </div></div>

    <script type="module">
        import { Conversation } from 'https://esm.sh/@elevenlabs/client';

        // â”€â”€ State â”€â”€
        let conversation = null;
        let conversationId = null;
        let timerInterval = null;
        let seconds = 0;
        let exchangeCount = 0;
        let transcriptHistory = [];
        let scenarios = [];
        let selectedScenarios = [];
        let currentExaminer = 'Dr Whitmore';
        let examinerSwitched = false;
        let firstMessageReceived = false;

        // â”€â”€ Load scenario bank â”€â”€
        fetch('/scenarios.json').then(r => r.json()).then(data => {
            scenarios = data;
            console.log(`Loaded ${scenarios.length} scenarios`);
        });

        function pickTwo() {
            const shuffled = [...scenarios].sort(() => Math.random() - 0.5);
            return [shuffled[0], shuffled[1]];
        }

        // â”€â”€ UI helpers â”€â”€
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function addMsg(text, role, examiner) {
            const container = document.getElementById('transcript');
            const msg = document.createElement('div');
            msg.className = 'transcript-msg ' + role;
            if (role === 'examiner') msg.setAttribute('data-examiner', examiner || 'Examiner');
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            transcriptHistory.push({ text, role, examiner, time: seconds });
            if (role === 'candidate') exchangeCount++;
        }

        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusText');
            dot.className = 'status-dot';
            if (state) dot.classList.add(state);
            label.textContent = text || '';
        }

        function updateExaminerBadge(name) {
            document.getElementById('examinerBadge').textContent = name;
        }

        function fmt(s) {
            return Math.floor(s / 60).toString().padStart(2, '0') + ':' + (s % 60).toString().padStart(2, '0');
        }

        function checkExaminerSwitch(text) {
            if (examinerSwitched) return;
            if (!firstMessageReceived) { firstMessageReceived = true; return; }
            const handoverPhrases = [
                'colleague will now continue', 'colleague will continue',
                'my colleague', 'concludes my section', 'that concludes my',
                'I am Dr Harris', "I'm Dr Harris", 'over to you'
            ];
            const lower = text.toLowerCase();
            if (handoverPhrases.some(p => lower.includes(p.toLowerCase()))) {
                examinerSwitched = true;
                currentExaminer = 'Dr Harris';
                updateExaminerBadge('Dr Harris');
                addMsg('Examiner handover â€” Dr Harris now examining', 'system');
            }
        }

        // â”€â”€ Results fetching â”€â”€
        async function fetchResults(convId, retries = 10) {
            for (let i = 0; i < retries; i++) {
                await new Promise(r => setTimeout(r, 3000)); // Wait 3s between attempts
                try {
                    const resp = await fetch(`/api/results/${convId}`);
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    if (data.analysis && data.analysis.data_collection_results) {
                        return data.analysis;
                    }
                } catch (e) {
                    console.log('Results not ready yet, retrying...', e);
                }
            }
            return null;
        }

        function renderResults(analysis) {
            const panel = document.getElementById('resultsPanel');
            const loading = document.getElementById('resultsLoading');

            if (!analysis) {
                loading.innerHTML = 'âš  Could not retrieve performance analysis. Review the transcript instead.';
                return;
            }

            // data_collection_results is keyed by id, each has .value
            const dcRaw = analysis.data_collection_results || {};
            const dc = {};
            for (const [k, v] of Object.entries(dcRaw)) {
                dc[k] = typeof v === 'object' ? (v.value || '') : v;
            }
            const eval_ = analysis.evaluation_criteria_results || {};

            let html = '';

            // Grade card
            const grade = (dc.candidate_grade || '').trim();
            const gradeWord = grade.split(/[\s.,:â€”-]/)[0].toUpperCase();
            const gradeClass = gradeWord === 'DISTINCTION' ? 'distinction' :
                               gradeWord === 'PASS' ? 'pass' :
                               gradeWord === 'BORDERLINE' ? 'borderline' :
                               gradeWord === 'FAIL' ? 'fail' : '';
            if (grade) {
                html += `<div class="grade-card">
                    <div class="grade-label">Overall Grade</div>
                    <div class="grade-value ${gradeClass}">${gradeWord}</div>
                    <div class="grade-justification">${grade.replace(gradeWord, '').replace(/^[\s.,:â€”-]+/, '')}</div>
                </div>`;
            }

            // Evaluation criteria grid
            if (eval_ && Object.keys(eval_).length > 0) {
                html += '<div class="criteria-grid">';
                const criteriaList = Array.isArray(eval_) ? eval_ : Object.values(eval_);
                for (const c of criteriaList) {
                    const name = (c.criteria_id || c.name || '').replace(/_/g, ' ');
                    const result = c.result || 'unknown';
                    const cls = result === 'success' ? 'success' : 'failure';
                    html += `<div class="criteria-item">
                        <div class="label">${name}</div>
                        <div class="result ${cls}">${result === 'success' ? 'âœ“ Pass' : 'âœ— Needs work'}</div>
                    </div>`;
                }
                html += '</div>';
            }

            // Topic summaries
            if (dc.topic_1_summary) {
                html += `<div class="topic-card">
                    <h4>Dr Whitmore's Section</h4>
                    <p>${dc.topic_1_summary}</p>
                </div>`;
            }
            if (dc.topic_2_summary) {
                html += `<div class="topic-card">
                    <h4>Dr Harris's Section</h4>
                    <p>${dc.topic_2_summary}</p>
                </div>`;
            }

            // Areas for improvement
            if (dc.areas_for_improvement) {
                html += `<div class="improvement-card">
                    <h4>ðŸ“š Areas for Revision</h4>
                    <p>${dc.areas_for_improvement}</p>
                </div>`;
            }

            loading.style.display = 'none';
            panel.innerHTML += html;
        }

        // â”€â”€ End screen â”€â”€
        async function showEnd() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            document.getElementById('endDuration').textContent = fmt(seconds);
            document.getElementById('endExchanges').textContent = exchangeCount;

            const topicsEl = document.getElementById('endTopics');
            topicsEl.innerHTML = '<h3>Topics Examined</h3>' +
                selectedScenarios.map((s, i) =>
                    `<div class="topic-item">${i === 0 ? 'Dr Whitmore' : 'Dr Harris'}: ${s.topic}</div>`
                ).join('');

            // Log session data
            const sessionData = {
                scenarioIds: selectedScenarios.map(s => s.id),
                topics: selectedScenarios.map(s => s.topic),
                duration: seconds,
                exchanges: exchangeCount,
                transcript: transcriptHistory,
                conversationId: conversationId,
                timestamp: new Date().toISOString()
            };
            console.log('Session result:', sessionData);

            showScreen('endScreen');

            // Fetch and render results
            if (conversationId) {
                document.getElementById('endSubtitle').textContent = 'Analysing your performance...';
                const analysis = await fetchResults(conversationId);
                renderResults(analysis);
                document.getElementById('endSubtitle').textContent = 'Your viva session has concluded.';
            }
        }

        // â”€â”€ Begin Examination â”€â”€
        document.getElementById('beginBtn').addEventListener('click', async () => {
            const name = document.getElementById('candidateName').value.trim();
            if (!name) { document.getElementById('candidateName').focus(); return; }
            if (scenarios.length === 0) {
                document.getElementById('errorNotice').textContent = 'âš  Loading scenarios...';
                document.getElementById('errorNotice').style.display = 'block';
                return;
            }

            const btn = document.getElementById('beginBtn');
            const errEl = document.getElementById('errorNotice');
            errEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Connecting...';

            try { await navigator.mediaDevices.getUserMedia({ audio: true }); }
            catch (e) {
                document.getElementById('micNotice').style.display = 'block';
                btn.disabled = false; btn.textContent = 'Begin Examination'; return;
            }

            selectedScenarios = pickTwo();
            const s1 = selectedScenarios[0];
            const s2 = selectedScenarios[1];

            const dynamicVars = {
                candidate_name: name.split(' ').pop(),
                scenario_1_topic: s1.topic,
                scenario_1_opening: s1.opening,
                scenario_1_points: s1.points.join('; '),
                scenario_1_probes: s1.probes.join('; '),
                scenario_1_facts: s1.facts.join('; '),
                scenario_1_rescue: s1.rescue || 'Simplify the question',
                scenario_2_topic: s2.topic,
                scenario_2_opening: s2.opening,
                scenario_2_points: s2.points.join('; '),
                scenario_2_probes: s2.probes.join('; '),
                scenario_2_facts: s2.facts.join('; '),
                scenario_2_rescue: s2.rescue || 'Simplify the question'
            };

            try {
                conversation = await Conversation.startSession({
                    agentId: 'agent_7401kgyecx7mewbv2c8gs5f0ff39',
                    connectionType: 'webrtc',
                    dynamicVariables: dynamicVars,
                    onConnect: () => {
                        updateStatus('connected', 'Connected');
                    },
                    onDisconnect: () => showEnd(),
                    onMessage: (msg) => {
                        if (msg.source === 'ai' && !msg.isTentative) {
                            checkExaminerSwitch(msg.message);
                            addMsg(msg.message, 'examiner', currentExaminer);
                            updateStatus('speaking', currentExaminer + ' is speaking...');
                        } else if (msg.source === 'user' && !msg.isTentative) {
                            addMsg(msg.message, 'candidate');
                            updateStatus('listening', 'Listening...');
                        }
                    },
                    onModeChange: (mode) => {
                        if (mode.mode === 'listening') updateStatus('listening', 'Listening...');
                        else if (mode.mode === 'speaking') updateStatus('speaking', currentExaminer + ' is speaking...');
                    },
                    onError: (err) => console.error('EL error:', err)
                });

                // Extract conversation ID from the connection/room name
                // Room name format: room_agent_{agentId}_conv_{convId}
                try {
                    const connStr = JSON.stringify(conversation.connection || {});
                    const convMatch = connStr.match(/conv_[a-z0-9]+/);
                    if (convMatch) conversationId = convMatch[0];
                    console.log('Conversation ID from connection:', conversationId);
                } catch (e) {
                    console.log('Could not extract conversation ID:', e);
                }

                document.getElementById('displayName').textContent = name;
                showScreen('examScreen');
                console.log('SCENARIO 1:', selectedScenarios[0].topic, '| SCENARIO 2:', selectedScenarios[1].topic);
                document.title = selectedScenarios[0].topic.substring(0, 30) + ' / ' + selectedScenarios[1].topic.substring(0, 30);
                seconds = 0;
                exchangeCount = 0;
                transcriptHistory = [];
                currentExaminer = 'Dr Whitmore';
                examinerSwitched = false;
                firstMessageReceived = false;
                updateExaminerBadge('Dr Whitmore');
                document.getElementById('transcript').innerHTML = '';
                document.getElementById('resultsPanel').innerHTML = '<div class="results-loading" id="resultsLoading"><span class="spinner"></span> Generating your performance report...</div>';

                timerInterval = setInterval(() => {
                    seconds++;
                    const el = document.getElementById('timer');
                    el.textContent = fmt(seconds);
                    if (seconds >= 840) { el.classList.add('critical'); el.classList.remove('warning'); }
                    else if (seconds >= 600) { el.classList.add('warning'); }
                }, 1000);
            } catch (e) {
                console.error('Start failed:', e);
                errEl.textContent = 'âš  Connection failed: ' + e.message;
                errEl.style.display = 'block';
                btn.disabled = false; btn.textContent = 'Begin Examination';
            }
        });

        // â”€â”€ Controls â”€â”€
        document.getElementById('endBtn').addEventListener('click', async () => {
            if (conversation) { await conversation.endSession(); conversation = null; }
            showEnd();
        });

        document.getElementById('retryBtn').addEventListener('click', () => {
            document.getElementById('beginBtn').disabled = false;
            document.getElementById('beginBtn').textContent = 'Begin Examination';
            document.getElementById('timer').className = 'timer';
            currentExaminer = 'Dr Whitmore';
            examinerSwitched = false;
            firstMessageReceived = false;
            conversationId = null;
            updateExaminerBadge('Dr Whitmore');
            showScreen('entryScreen');
        });

        document.getElementById('reviewBtn').addEventListener('click', () => {
            document.getElementById('reviewContent').innerHTML = transcriptHistory.map(t =>
                '<div class="transcript-msg ' + t.role + '"' +
                (t.role === 'examiner' ? ' data-examiner="' + t.examiner + '"' : '') +
                ' style="margin-bottom:0.5rem;">' +
                '<span style="color:#555;font-size:0.7rem;">' + fmt(t.time) + '</span> ' +
                t.text + '</div>'
            ).join('');
            document.getElementById('reviewModal').style.display = 'block';
        });

        document.getElementById('closeReviewBtn').addEventListener('click', () => {
            document.getElementById('reviewModal').style.display = 'none';
        });

        document.getElementById('candidateName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') document.getElementById('beginBtn').click();
        });
    </script>
</body>
</html>
